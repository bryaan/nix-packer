# About

This is a [Packer](http://packer.io) definition for [NixOS](http://nixos.org). It builds a [Vagrant](http://www.vagrantup.com/) box for various NixOS versions.

You will need to add:
  /usr/local/bin/fish
to /etc/shells.

Then run:
  chsh -s /usr/local/bin/fish
to make fish your default shell.


# TODO Could be bc ssh_private_key in packer-template is actually the key 
to use to connect to the machine. ie the key specified in its authd_keys
https://github.com/hashicorp/packer/blob/master/builder/googlecompute/step_create_ssh_key.go
Nvm according to that it is for the instance.


# So run sshd in verbose or enable logging or both


# Resources

[NixOS Config Options](https://nixos.org/nixos/manual/options.html)

[NixOS SSHd Config](https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/ssh/sshd.nix)

[Nix Networking Config](https://github.com/NixOS/nixos/blob/master/modules/tasks/network-interfaces.nix)

[Vagrant Settings](https://www.vagrantup.com/docs/vagrantfile/machine_settings.html)

[NixOS ISOs](https://nixos.org/channels/)

# Usage

```

packer build packer_builds/nixos-17.09-x86_64.json


vagrant up
```

systemctl start display-manager


Should be able to:

nixops ssh machine

https://github.com/zefhemel/nixops-mac-setup/blob/master/install-nix.sh



TODO Root account has no password set.  Double check this isnt a problem.

TODO replace `ssh_username` in packer-template.json with variable.





Authorized Keys for SSH-ing into machine go in `./nixos/users.nix`

By default it is set to `~/.ssh/id_rsa.pub`. One of the host OS user's keys, hopefully.

The SSH keypair to be used by the OS (and kept 100% private) is 
generated by the `openssh.hostKeys` config var.




TODO There is a private key to be used by the system itself, like
for its side of SSH.  What we should do is have that key autogenerated in the post_install.sh script.

ACTUALLY, nvm in NixOS since we setup sshd in the NixOS Config, we don't need to set `ssh_private_key_file` in packer.

"communicator": "ssh",
"ssh_username": "vagrant",
"ssh_port": 22,
"ssh_private_key_file": "./scripts/install_rsa",
"ssh_wait_timeout": "25m",

    "disk_size":  "{{env `DISK_SIZE`}}",




TODO On CLASS and KMachines
https://nixos.org/nixos/manual/options.html#opt-power.ups.enable




# Building

If you want to customize the box, there are a couple
[variables](http://www.packer.io/docs/templates/user-variables.html) you can
pass to Packer:

* `swap_size` - The size of the swap partition in megabytes. If this is empty (the
  default), no swap partition is created.
* `disk_size` - The total size of the hard disk in megabytes (defaults
  to 2000).
* `graphical` - Set this to true to get a graphical desktop

There are also a couple of variables that only affect the virtual-box build:

* `memmory_size` - The amount of RAM in megabytes (defaults to 1024).
* `cpus` - The number of CPUs (defaults to 1).

Example:

``` bash
$ sh ./build-stable.sh    \
    -var 'cpus=2'         \
    -var 'swap_size=2000'
```
